name: PR Title Check

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
      - reopened

jobs:
  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Validate PR Title Format
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            
            // Define valid types and their version bump effect
            const types = {
              'fix': 'patch',
              'feat': 'minor',
              'feature': 'minor',
              'chore': 'none',
              'docs': 'none',
              'style': 'none',
              'refactor': 'none',
              'test': 'none',
              'ci': 'none',
              'perf': 'patch',
              'build': 'none',
              'revert': 'patch'
            };
            
            // Regular expressions for validation
            const conventionalCommitPattern = /^(\w+)(\(\w+\))?:\s.{3,}$/;
            const majorPrefixPattern = /^\[major\]\s.{3,}$/i;
            const majorTypePattern = /^major:\s.{3,}$/i;
            
            let isValid = false;
            let bumpType = 'none';
            let errorMessage = '';
            
            // Check for major version indicators
            if (majorPrefixPattern.test(prTitle)) {
              isValid = true;
              bumpType = 'major';
              console.log('‚úì Valid PR title with [major] prefix');
            } else if (majorTypePattern.test(prTitle)) {
              isValid = true;
              bumpType = 'major';
              console.log('‚úì Valid PR title with major: prefix');
            } else if (conventionalCommitPattern.test(prTitle)) {
              // Extract type from conventional commit format
              const match = prTitle.match(/^(\w+)/);
              const type = match ? match[1].toLowerCase() : '';
              
              if (types[type]) {
                isValid = true;
                bumpType = types[type];
                console.log(`‚úì Valid PR title with type '${type}' (${bumpType} bump)`);
              } else {
                errorMessage = `Invalid commit type '${type}'. Valid types are: ${Object.keys(types).join(', ')}`;
              }
            } else {
              errorMessage = 'PR title does not follow conventional commit format';
            }
            
            // Helper to post/update comment
            const marker = '<!-- pr-title-check -->';
            const postComment = async (body) => {
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
              });
              const existing = comments.data.find(c => c.body.includes(marker));
              
              const payload = {
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `${marker}\n${body}`
              };
              
              if (existing) {
                await github.rest.issues.updateComment({...payload, comment_id: existing.id});
              } else {
                await github.rest.issues.createComment({...payload, issue_number: context.payload.pull_request.number});
              }
            };
            
            // Post result
            if (isValid) {
              const emoji = {'major': 'üî¥', 'minor': 'üü°', 'patch': 'üü¢', 'none': '‚ö™'}[bumpType];
              const releaseNote = bumpType === 'none' ? ' (no release)' : '';
              await postComment(`‚úÖ **Valid** ‚Äî ${emoji} ${bumpType.toUpperCase()}${releaseNote}`);
              console.log(`‚úì Valid: ${bumpType} bump`);
            } else {
              const errorBody = [
                '‚ùå **Invalid**',
                '',
                `**Error:** ${errorMessage}`,
                '',
                '**Format:** `type: description` or `[major] description`',
                '',
                '**Valid types:** fix, feat, major, chore, docs, style, refactor, test, ci, perf, build, revert',
                '',
                'See [CONTRIBUTING.md](https://github.com/snyk/cli-extension-dep-graph/blob/main/CONTRIBUTING.md) for examples.'
              ].join('\n');
              await postComment(errorBody);
              core.setFailed(errorMessage);
            }
